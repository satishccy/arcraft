const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/App-58ab7d48-D4apTjiz.js","assets/index-B4Utbos2.js","assets/index-DYdVBiGI.css","assets/index-DHW4Loss.js"])))=>i.map(i=>d[i]);
import{a as N,b as O,_,B as I}from"./index-B4Utbos2.js";import{W as b}from"./index-DHW4Loss.js";function f(i,t,e,n){return new(e||(e=Promise))(function(s,r){function o(l){try{a(n.next(l))}catch(c){r(c)}}function d(l){try{a(n.throw(l))}catch(c){r(c)}}function a(l){var c;l.done?s(l.value):(c=l.value,c instanceof e?c:new e(function(u){u(c)})).then(o,d)}a((n=n.apply(i,[])).next())})}class v extends Error{constructor(t,e,...n){super(...n),Error.captureStackTrace&&Error.captureStackTrace(this,v),this.name="DeflyWalletConnectError",this.data=t,this.message=e}}const y="defly-wallet-connect-modal-wrapper",E="defly-wallet-redirect-modal-wrapper",A="defly-wallet-sign-txn-toast-wrapper",q="defly-wallet-sign-txn-modal-wrapper",W="defly-wallet-modal";function S(i){const t=document.createElement("div");return t.setAttribute("id",i),document.body.appendChild(t),t}function w(i){const t=document.getElementById(i);t&&t.remove()}const g={WALLET:"DeflyWallet.Wallet",WALLETCONNECT:"walletconnect"};function m(){return typeof localStorage>"u"?void 0:localStorage}function x(){const i=function(){var e;const n=(e=m())===null||e===void 0?void 0:e.getItem(g.WALLET);return n?JSON.parse(n):null}();let t=null;return(i==null?void 0:i.type)==="defly-wallet"&&(t="mobile"),t}function P(i){const t=i.slice();for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t}const M="https://static.defly.app/wc-bridge-servers.json";function D(){return function(i,t={}){return fetch(i,t).then(e=>e.json()).then(e=>e)}(M,{cache:"no-store"})}function C(){return f(this,void 0,void 0,function*(){let i={bridgeURL:"",shouldUseSound:!0,silent:!1};try{const t=yield D();t.use_sound!==void 0&&(i.shouldUseSound=t.use_sound),t.silent!==void 0&&(i.silent=t.silent),i=Object.assign(Object.assign({},i),{bridgeURL:P(t.servers||[])[0]||""})}catch(t){console.log(t)}return i})}function B(i){return Uint8Array.from(window.atob(i),t=>t.charCodeAt(0))}function p(){return typeof navigator<"u"}function G(){return p()&&/Android/i.test(navigator.userAgent)}function $(){return p()&&/iPhone|iPad|iPod/i.test(navigator.userAgent)}function L(){return p()&&/iPhone|iPod|iPad|Android/i.test(navigator.userAgent)}function H(){if(!p())return null;const{userAgent:i}=navigator;let t;return t=i.match(/DuckDuckGo/i)?"DuckDuckGo":i.match(/OPX/i)?"Opera GX":navigator.brave?"Brave":I.getParser(navigator.userAgent).getBrowserName(),t}function U({shouldUseSound:i}){return{open:(t={shouldUseSound:i},e=>{if(!document.getElementById(y)){const n=S(y),s=`${e}&algorand=true`,{shouldUseSound:r}=t;n.innerHTML=`<defly-wallet-connect-modal uri="${s}" should-use-sound="${r}"></defly-wallet-connect-modal>`}}),close:()=>w(y)};var t}class k{constructor(t){this.bridge=(t==null?void 0:t.bridge)||"",this.connector=null,this.shouldShowSignTxnToast=(t==null?void 0:t.shouldShowSignTxnToast)===void 0||t.shouldShowSignTxnToast,this.chainId=t==null?void 0:t.chainId}get platform(){return x()}get isConnected(){return this.platform==="mobile"&&!!this.connector}connect(){return new Promise((t,e)=>f(this,void 0,void 0,function*(){var n;try{if(!((n=this.connector)===null||n===void 0)&&n.connected)try{yield this.connector.killSession()}catch{}const{bridgeURL:s,shouldUseSound:r}=yield C();this.connector=new b({bridge:this.bridge||s||"https://bridge.walletconnect.org",qrcodeModal:U({shouldUseSound:r})}),yield this.connector.createSession({chainId:this.chainId||4160}),function(o){var d,a,l,c;const u=document.getElementById(y),h=(a=(d=u==null?void 0:u.querySelector("defly-wallet-connect-modal"))===null||d===void 0?void 0:d.shadowRoot)===null||a===void 0?void 0:a.querySelector(`.${W}`),T=(c=(l=h==null?void 0:h.querySelector("defly-wallet-modal-header"))===null||l===void 0?void 0:l.shadowRoot)===null||c===void 0?void 0:c.getElementById("defly-wallet-modal-header-close-button");T==null||T.addEventListener("click",()=>{o(),w(y)})}(()=>e(new v({type:"CONNECT_MODAL_CLOSED"},"Connect modal is closed by user"))),this.connector.on("connect",(o,d)=>{var a,l;o&&e(o),t(((a=this.connector)===null||a===void 0?void 0:a.accounts)||[]),function(c,u){var h;(h=m())===null||h===void 0||h.setItem(g.WALLET,JSON.stringify({type:u||"defly-wallet",accounts:c,selectedAccount:c[0]}))}(((l=this.connector)===null||l===void 0?void 0:l.accounts)||[])})}catch(s){e(new v({type:"SESSION_CONNECT",detail:s},s.message||"There was an error while connecting to Defly Wallet"))}}))}reconnectSession(){return new Promise((t,e)=>f(this,void 0,void 0,function*(){var n,s;try{this.connector&&t(this.connector.accounts||[]),this.bridge=((n=function(){var r;const o=(r=m())===null||r===void 0?void 0:r.getItem(g.WALLETCONNECT);return o?JSON.parse(o):null}())===null||n===void 0?void 0:n.bridge)||"",this.bridge&&(this.connector=new b({bridge:this.bridge}),t(((s=this.connector)===null||s===void 0?void 0:s.accounts)||[])),this.isConnected||t([])}catch(r){yield this.disconnect(),e(new v({type:"SESSION_RECONNECT",detail:r},r.message||"There was an error while reconnecting to Defly Wallet"))}}))}disconnect(){var t;return f(this,void 0,void 0,function*(){let e;this.isConnected&&this.platform==="mobile"&&(e=(t=this.connector)===null||t===void 0?void 0:t.killSession(),e==null||e.then(()=>{this.connector=null})),yield new Promise((n,s)=>{var r,o;try{(r=m())===null||r===void 0||r.removeItem(g.WALLETCONNECT),(o=m())===null||o===void 0||o.removeItem(g.WALLET),n(void 0)}catch(d){s(d)}})})}signTransactionWithMobile(t){return f(this,void 0,void 0,function*(){const e=(n="algo_signTxn",s=[t],{id:Date.now()*Math.pow(10,3)+Math.floor(Math.random()*Math.pow(10,3)),jsonrpc:"2.0",method:n,params:s});var n,s;try{try{const{silent:r}=yield C(),o=(yield this.connector.sendCustomRequest(e,{forcePushNotification:!r})).filter(Boolean);return typeof o[0]=="string"?o.map(B):o.map(d=>Uint8Array.from(d))}catch(r){return yield Promise.reject(new v({type:"SIGN_TRANSACTIONS",detail:r},r.message||"Failed to sign transaction"))}}finally{w(E),w(A)}})}signTransaction(t,e){return f(this,void 0,void 0,function*(){if(this.platform==="mobile"&&(L()?S(E).innerHTML="<defly-wallet-redirect-modal></defly-wallet-redirect-modal>":!L()&&this.shouldShowSignTxnToast&&(S(A).innerHTML="<defly-wallet-sign-txn-toast></defly-wallet-sign-txn-toast>"),!this.connector))throw new Error("DeflyWalletConnect was not initialized correctly.");const n=t.flatMap(s=>s.map(r=>function(o,d){let a;d&&!(o.signers||[]).includes(d)&&(a=[]);const l={txn:(c=o.txn,Buffer.from(N.encodeUnsignedTransaction(c)).toString("base64"))};var c;return Array.isArray(a)&&(l.signers=a),o.authAddr&&(l.authAddr=o.authAddr),o.message&&(l.message=o.message),o.msig&&(l.msig=o.msig),l}(r,e)));return this.signTransactionWithMobile(n)})}}typeof window<"u"&&(window.global=window,window.Buffer=window.Buffer||O.Buffer,_(()=>import("./App-58ab7d48-D4apTjiz.js"),__vite__mapDeps([0,1,2,3])));const J=Object.freeze(Object.defineProperty({__proto__:null,DeflyWalletConnect:k},Symbol.toStringTag,{value:"Module"}));export{G as A,L as C,$ as E,H as L,q as a,A as c,W as d,w as f,J as i,y as l,E as s};
